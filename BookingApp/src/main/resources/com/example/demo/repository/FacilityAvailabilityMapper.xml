<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.repository.FacilityAvailabilityMapper">

  <!-- マッピング定義 -->
  <resultMap id="FacilityAvailabilityResultMap" type="FacilityAvailability">
    <result property="date" column="calendar_date" />
    <result property="facilityTypeId" column="facility_type_id" />
    <result property="availabilityCount" column="availability_count" />
    <result property="maxCount" column="max_count" />
    <result property="startTime" column="start_time" />
    <result property="endTime" column="end_time" />
  </resultMap>
  

  <!-- 空き状況検索（日付範囲） -->
  <select id="findFacilityAvailability" resultMap="FacilityAvailabilityResultMap">
    SELECT
      calendar_date,
      facility_type_id,
      start_time,
      end_time,
      availability_count,
      max_count
    FROM
      facility_availability
    WHERE
      facility_type_id = #{facilityTypeId}
      AND calendar_date BETWEEN #{from} AND #{to}
    ORDER BY calendar_date
  </select>

  <!-- 空き状況残数カウント -->
  <select id="countDaysNotAvailable" resultType="int">
    SELECT COUNT(*)
    FROM facility_availability
    WHERE facility_type_id = #{facilityTypeId}
      AND calendar_date BETWEEN #{from} AND #{to}
      AND availability_count = 0
  </select>

  <!-- 空き状況減算（予約時） -->
  <update id="reduceAvailabilityCount">
    UPDATE facility_availability
    SET availability_count = availability_count - 1
    WHERE calendar_date = #{date}
      AND facility_type_id = #{facilityTypeId}
      AND NOT (end_time &lt;= #{startTime} OR start_time &gt;= #{endTime})
  </update>

  <!-- 日単位空き状況取得 -->
  <select id="findFacilityAvailabilityOnDate" resultMap="FacilityAvailabilityResultMap">
    SELECT
      calendar_date,
      facility_type_id,
      availability_count,
      max_count
    FROM facility_availability
    WHERE facility_type_id = #{facilityTypeId}
      AND calendar_date = #{date}
  </select>

  <!-- 時間帯空き状況取得 -->
  <select id="findFacilityAvailabilityForTimeRange" resultMap="FacilityAvailabilityResultMap">
    SELECT
      calendar_date,
      facility_type_id,
      availability_count,
      max_count
    FROM facility_availability
    WHERE facility_type_id = #{facilityTypeId}
      AND calendar_date = #{date}
      AND start_time &lt; #{endTime}
      AND end_time &gt; #{startTime}
      AND availability_count &gt; 0
  </select>

  <!-- 空き状況復元（キャンセル時） -->
  <update id="restoreAvailabilityCount">
    UPDATE facility_availability
    SET availability_count = availability_count + 1
    WHERE facility_type_id = #{facilityTypeId}
      AND calendar_date = #{date}
      AND start_time = #{startTime}
      AND end_time = #{endTime}
  </update>

</mapper>
